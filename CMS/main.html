<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title id="websiteName"></title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="css/custom.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>

  <div class="container">
    <button id="btnLogout" class="btn btn-danger">Logout</button>

    <br>

    <h1>Settings</h1>
    <input id="websiteNameInputField" type="text" name="websiteName">
    <button id="webisteNameInputFieldButton" class="btn btn-success" onclick="changeWebsiteName();">Set Website Name</button>

    <br>

    <h1>Navbar</h1>
    <input id="brandNameInputField" type="text" name="brandName">
    <button id="brandNameInputFieldButton" class="btn btn-success" onclick="changeBrandName();">Set Brand Name</button>
    <br>
    <input id="firstLinkInputField" type="text" name="firstLink">
    <button id="firstLinkInputFieldButton" class="btn btn-success" onclick="changeFirstLink();">Set First Link</button>
    <br>
    <input id="secondLinkInputField" type="text" name="secondLink">
    <button id="secondLinkInputFieldButton" class="btn btn-success" onclick="changeSecondLink();">Set Second Link</button>
    <br>
    <input id="thirdLinkInputField" type="text" name="thirdLink">
    <button id="thirdLinkInputFieldButton" class="btn btn-success" onclick="changeThirdLink();">Set Third Link</button>
    <br>
    <input id="fourthLinkInputField" type="text" name="fourthLink">
    <button id="fourthLinkInputField" class="btn btn-success" onclick="changeFourthLink();">Set Fourth Link</button>
    <br>
    <input id="fifthLinkInputField" type="text" name="fifthLink">
    <button id="fifthLinkInputFieldButton" class="btn btn-success" onclick="changeFifthLink();">Set Fifth Link</button>

    <br>

    <h1>Homework and Worksheets</h1>
    <input id="homeworkWorksheetsPageTitleInputField" type="text" name="websiteName">
    <button id="homeworkWorksheetsPageTitleInputFieldButton" class="btn btn-success" onclick="changeHomeworkWorksheetsPageTitle();">Set Page Title</button>

    <br>

    <input id="amountOfPostsOnScreenHomeworkWorksheetsInputField" type="text" name="amountOfPostsOnScreenHomeworkWorksheets">
    <button id="amountOfPostsOnScreenHomeworkWorksheetsInputFieldButton" class="btn btn-success" onclick="changeAmountOfPostsOnScreenHomeworkWorksheetsInputField();">Set How Many Articles Display</button>

    <h2>New Post</h2>

    <button id="editPostsModalButton" class="btn btn-success" data-toggle="modal" data-target="#editPostsModal">
        Edit Posts
    </button>

    <div id="content-creator">
    <label>
        Title
    </label>
    <br/>
    <input 
        type="text" 
        placeholder="Title" 
        name="title"
        id="title"
        style="width: 100%"/>
    <br/>
    <label>
        Due Date
    </label>
    <br/>
    <input 
        type="date" 
        placeholder="Due Date" 
        name="date"
        id="date"
        style="width: 100%"/>
    <br/>
    <label>
        Body
    </label>
    <br/>
    <textarea 
        name="body" 
        id="body" 
        rows="5" 
        placeholder="Body Text" 
        style="width: 100%">
    </textarea>
    <br/>
    <button id="submit-button" class="btn btn-success">
        Submit
    </button>

    <br>

    <progress value="0" max="100" id="uploader">0%</progress>
    <br>
    <input type="file" value="upload" id="fileButtonHomeworkWorksheets">
    <br>
    <button id="fileUploadButtonHomeworkWorksheets" class="btn btn-success" onclick="uploadFileHomeworkWorksheets();">Upload Image</button>
  </div>

  <!-- Edit Posts Modal -->
  <div class="modal fade" id="editPostsModal" tabindex="-1" role="dialog" aria-labelledby="postsLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="postsLabel">Edit Posts</h4>
        </div>
        <div class="modal-body" id="content">
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="savePostsModalButton" data-dismiss="modal">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Posts Button Modal -->
  <div class="modal fade" id="editPostsButtonModal" tabindex="-1" role="dialog" aria-labelledby="postsLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="postsButtonLabel">Edit Posts</h4>
        </div>
        <div class="modal-body" id="content">
          <div id="content-creator">
            <label>
                Title
            </label>
            <br/>
            <input 
                type="text" 
                placeholder="Title" 
                name="title"
                id="editPostsTitle"
                style="width: 100%"/>
            <br/>
            <label>
                Due Date
            </label>
            <br/>
            <input 
                type="date" 
                placeholder="Due Date" 
                name="date"
                id="editPostsDate"
                style="width: 100%"/>
            <br/>
            <label>
                Body
            </label>
            <br/>
            <textarea 
                name="body" 
                id="editPostsBody" 
                rows="5" 
                placeholder="Body Text" 
                style="width: 100%">
            </textarea>
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal" id="editPostsButtonModalDelete">Delete</button>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="editPostsButtonModalClose">Close</button>
          <button type="button" class="btn btn-success" id="saveEditsPostsModalButton" data-dismiss="modal">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>

  <script>
    var config = {
      apiKey: "AIzaSyDDahul-ML9670Hw4fBhG8MCosixAw86fA",
      authDomain: "jessicas-website.firebaseapp.com",
      databaseURL: "https://jessicas-website.firebaseio.com",
      projectId: "jessicas-website",
      storageBucket: "",
      messagingSenderId: "277398527548"
    };

    firebase.initializeApp(config);

    var dbRef = firebase.database();

    var websiteName = document.getElementById('websiteName');

    dbRef.ref('Settings').child('websiteName').on('value', snap => websiteName.innerText = snap.val());

    //Settings
    var websiteNameInputField = document.getElementById('websiteNameInputField');

    dbRef.ref('Settings').child('websiteName').on('value', snap => websiteNameInputField.value = snap.val());

    function changeWebsiteName() {
      var newWebsiteName = websiteNameInputField.value;

      dbRef.ref("Settings").update({
        websiteName: newWebsiteName
      });
    };
    
    //Navbar
    var brandNameInputField = document.getElementById('brandNameInputField');

    dbRef.ref('Navbar').child('brandName').on('value', snap => brandNameInputField.value = snap.val());

    function changeBrandName() {
      var newBrandName = brandNameInputField.value;

      dbRef.ref("Navbar").update({
        brandName: newBrandName
      });
    };

    var firstLinkInputField = document.getElementById('firstLinkInputField');

    dbRef.ref('Navbar').child('firstLink').on('value', snap => firstLinkInputField.value = snap.val());

    function changeFirstLink() {
      var newfirstLink = firstLinkInputField.value;

      dbRef.ref("Navbar").update({
        firstLink: newfirstLink
      });
    };

    var secondLinkInputField = document.getElementById('secondLinkInputField');

    dbRef.ref('Navbar').child('secondLink').on('value', snap => secondLinkInputField.value = snap.val());

    function changeSecondLink() {
      var newSecondLink = secondLinkInputField.value;

      dbRef.ref("Navbar").update({
        secondLink: newSecondLink
      });
    };

    var thirdLinkInputField = document.getElementById('thirdLinkInputField');

    dbRef.ref('Navbar').child('thirdLink').on('value', snap => thirdLinkInputField.value = snap.val());

    function changeThirdLink() {
      var newThirdLink = thirdLinkInputField.value;

      dbRef.ref("Navbar").update({
        thirdLink: newThirdLink
      });
    };

    var fourthLinkInputField = document.getElementById('fourthLinkInputField');

    dbRef.ref('Navbar').child('fourthLink').on('value', snap => fourthLinkInputField.value = snap.val());

    function changeFourthLink() {
      var newFourthLink = fourthLinkInputField.value;

      dbRef.ref("Navbar").update({
        fourthLink: newFourthLink
      });
    };

    var fifthLinkInputField = document.getElementById('fifthLinkInputField');

    dbRef.ref('Navbar').child('fifthLink').on('value', snap => fifthLinkInputField.value = snap.val());

    function changeFifthLink() {
      var newFifthLink = fifthLinkInputField.value;

      dbRef.ref("Navbar").update({
        fifthLink: newFifthLink
      });
    };

    //Homework and Worksheets
    var homeworkWorksheetsPageTitleInputField = document.getElementById('homeworkWorksheetsPageTitleInputField');

    dbRef.ref('HomeworkWorksheets').child('pageTitle').on('value', snap => homeworkWorksheetsPageTitleInputField.value = snap.val());

    function changeHomeworkWorksheetsPageTitle() {
      var newHomeworkWorksheetsPageTitle = homeworkWorksheetsPageTitleInputField.value;

      dbRef.ref("HomeworkWorksheets").update({
        pageTitle: newHomeworkWorksheetsPageTitle
      });
    };

    var amountOfPostsOnScreenHomeworkWorksheetsInputField = document.getElementById('amountOfPostsOnScreenHomeworkWorksheetsInputField');

    dbRef.ref('HomeworkWorksheets').child('amountOnScreen').on('value', snap => amountOfPostsOnScreenHomeworkWorksheetsInputField.value = snap.val());

    function changeAmountOfPostsOnScreenHomeworkWorksheetsInputField() {
      var newAmountOfPostsOnScreenHomeworkWorksheets = amountOfPostsOnScreenHomeworkWorksheetsInputField.value;

      dbRef.ref("HomeworkWorksheets").update({
        amountOnScreen: newAmountOfPostsOnScreenHomeworkWorksheets
      });
    };

    btnLogout.addEventListener('click', e => {
      firebase.auth().signOut();
    });

    firebase.auth().onAuthStateChanged(firebaseUser => {
      if(firebaseUser) {
        console.log(firebaseUser);
      } else {
        window.location = "index.html";
      }
  });


  var submitButton = document.getElementById('submit-button');
  var titleText = document.getElementById('title');
  var bodyText = document.getElementById('body');
  var dueDateText = document.getElementById('date');

  submitButton.addEventListener('click', function(){
  var title = titleText.value;
  var body = bodyText.value;
  var dueDate = dueDateText.value;
  
  // Add this here
  var articleRef = 'HomeworkWorksheets/';
  var articleData = {
    title: title,
    body: body,
    dueDate: dueDate,
    date_edited: firebase.database.ServerValue.TIMESTAMP,
   slug_name: title.replace(/\s/g, '-')
  };
  var key = firebase.database().ref(articleRef + 
    'post').push().key;
  
  var updates = {};
  updates[articleRef + 'posts/' + key] = articleData;
  
  return firebase
    .database()
    .ref()
    .update(updates)
    .then(function(){
       alert('Added ' + title);
    })
    .catch(function(error) {
       console.log(error);
       alert(error.message)
    });
  });

  // var uploader = document.getElementById('uploader');
  // var fileButton = document.getElementById('fileButton');
  // var fileUploadButton = document.getElementById('fileUploadButton');


  var selectedFile;
  $('#fileUploadButtonHomeworkWorksheets').hide();

  $('#fileButtonHomeworkWorksheets').on('change', function(event) {
    selectedFile = event.target.files[0];
    $('#fileUploadButtonHomeworkWorksheets').show();
  })

  function uploadFileHomeworkWorksheets() {
    var filename = selectedFile.name;
    var storageRef = firebase.storage().ref('HomeworkWorksheets/images/' + filename);
    var uploadTask = storageRef.put(selectedFile);

    uploadTask.on('state_changed', function(snap) {

    },

    function(error) {

    }, function() {
      var downloadURL = uploadTask.snapshot.downloadURL;
      console.log(downloadURL);
    });
  }

  length = 10;
  var articles = []
  firebase.database().ref('HomeworkWorksheets/posts').orderByChild('published').on('child_added', function(data) {
    firebase.database().ref('HomeworkWorksheets/posts/' + data.key)
          .once('value', function(articleData) {
            articles.push({
              id: data.key,
              published: data.val().published,
              data: articleData.val()
            });
            articles.sort(function(a, b) {
              return a.published < b.published;
            });
            var i = articles.length-1;
            createArticle(articles[i].id, articles[i].date_edited, articles[i].data);
          }, function(err) {
            showError(err);
          });
        
      }, function(err) {
        alert(err);
      })

    function showError(err) {
      var el = document.createElement('div');
      el.innerHTML = err.message;
      document.getElementById('content').appendChild(el);
    }

    var publishedCheckBoxes = [];
    var ids = []
    function createArticle(id, date_edited, data) {
      var el = document.createElement('div');
      var title = document.createElement('h3');
      var date = document.createElement('h4');
      var checkBox = document.createElement('input');
      checkBox.type = "checkbox";
      checkBox.id = "checkBox";
      checkBox.setAttribute('onclick', 'setCheckBox(this)');

      var checkBoxLabel = document.createElement('label');
      checkBoxLabel.for = "checkBox";
      checkBoxLabel.name = "checkBoxLabel";
      var editButton = document.createElement('input');
      editButton.type = "button";
      editButton.className = "btn btn-default";
      editButton.value = "Edit";
      editButton.id = "editPostsButton";
      editButton.setAttribute('data-toggle', 'modal');
      editButton.setAttribute('postId', id);
      editButton.setAttribute('data-target', '#editPostsButtonModal');
      editButton.setAttribute('onclick', "editCertainPost(this.getAttribute('postId'))");
      var hrTag = document.createElement('hr');
      var editButtons = document.createElement('div');
      var space = document.createElement('h4');

      var monthNum = data.dueDate.substring(5, 7);
      var month = "";
      var day = data.dueDate.substring(8, 10);
      var year = data.dueDate.substring(0, 4);

      ids.push(id);


      if(monthNum == "01") { 
        month = "January";
      }
      if(monthNum == "02") {
        month = "February";
      }
      if(monthNum == "03") {
        month = "March";
      }
      if(monthNum == "04") {
        month = "April";
      }
      if(monthNum == "05") {
        month = "May";
      }
      if(monthNum == "06") {
        month = "June";
      }
      if(monthNum == "07") {
        month = "July";
      }
      if(monthNum == "08") {
        month = "August";
      }
      if(monthNum == "09") {
        month = "September";
      }
      if(monthNum == "10") {
        month = "October";
      }
      if(monthNum == "11") {
        month = "November";
      }
      if(monthNum == "12") {
        month = "December";
      }

      checkBox.setAttribute('checked', data.published);
      console.log(data.title + " " + data.published)
      
      publishedCheckBoxes.push(checkBox);

      title.innerHTML = data.title;
      date.innerHTML = 'Date: '+ new Date(date_edited) + ' ' + 'Due Date: ' + month + ' ' + day + ', ' + year + ' ';
      space.innerHTML = " ";
      checkBoxLabel.innerHTML = "Published";

      editButtons.appendChild(checkBoxLabel);
      editButtons.appendChild(checkBox);
      editButtons.appendChild(space);
      editButtons.appendChild(editButton);

      el.appendChild(title);
      el.appendChild(date);
      el.appendChild(editButtons);
      el.appendChild(hrTag);
      document.getElementById('content').appendChild(el);
    }

    document.getElementById('savePostsModalButton').onclick = function() {
      var i = 0;
      firebase.database().ref('HomeworkWorksheets/posts').once('child_added', function(data) {
        firebase.database().ref('HomeworkWorksheets/posts/').once('value', function(articleData) {
          articleData.forEach(function(child){
            console.log(publishedCheckBoxes[i].getAttribute('checked'))
            console.log(i)
            console.log('this')
            firebase.database().ref('HomeworkWorksheets/posts/').child(child.key).update({
              published: publishedCheckBoxes[i].getAttribute('checked')
            });
            i += 1;
          })
        });
      });
    }

    function setCheckBox(check) {
      console.log(check.checked);
      var int = publishedCheckBoxes.indexOf(check);
      console.log(int);
      publishedCheckBoxes[int].setAttribute('checked', check.checked);
    }

    var postsButtonLabel = document.getElementById('postsButtonLabel');
    var editPostsTitle = document.getElementById('editPostsTitle');
    var editPostsDate = document.getElementById('editPostsDate');
    var editPostsBody = document.getElementById('editPostsBody');

    var editPostId = "";

    function editCertainPost(id) {
      editPostId = id;

      dbRef.ref('HomeworkWorksheets/posts/' + id).child('title').on('value', snap => postsButtonLabel.innerHTML = snap.val());
      dbRef.ref('HomeworkWorksheets/posts/' + id).child('title').on('value', snap => editPostsTitle.value = snap.val());
      dbRef.ref('HomeworkWorksheets/posts/' + id).child('dueDate').on('value', snap => editPostsDate.value = snap.val());
      dbRef.ref('HomeworkWorksheets/posts/' + id).child('body').on('value', snap => editPostsBody.value = snap.val());
    }

    document.getElementById('saveEditsPostsModalButton').onclick = function() {
      firebase.database().ref('HomeworkWorksheets/posts/').child(editPostId).update({
        title: editPostsTitle.value,
        dueDate: editPostsDate.value,
        body: editPostsBody.value
      });

      $('.modal').modal('hide');
    }

    // $('#editPostsButtonModalDelete').on('click', function() {
    //   dbRef.ref('HomeworkWorksheets/posts/' + editPostId).remove();
    //   $('.modal').modal('hide');
    //   articles.remove()
    // })

    document.getElementById('editPostsButtonModalClose').onclick = function() {
      $('.modal').modal('hide');
    }
  </script>
</html>